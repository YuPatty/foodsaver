{% extends "base.html" %}
{% block title %}å–œå¥½é …ç›®{% endblock %}
{% block content %}

<style>
/* ç‰ˆé¢ï¼šå·¦å´ 260px å´é‚Šæ¬„ + å³å´ä¸»è¦å…§å®¹ */
.fav-shell { display: grid; grid-template-columns: 260px 1fr; gap: 24px; min-height: calc(100vh - 40px); }

/* å´é‚Šæ¬„ */
.fav-side { background: #eee7dc; border-radius: 12px; padding: 20px; color: #6b4f2a; }
.fav-user { display:flex; align-items:center; gap:10px; font-weight:600; margin-bottom: 22px; }
.fav-menu { list-style: disc; padding-left: 22px; margin: 0; }
.fav-menu li { margin: 12px 0; }
.fav-menu a { color: #6b4f2a; text-decoration: none; }
.fav-menu .is-active > a { text-decoration: underline; font-weight: 700; }

/* å³å´å€åŸŸ */
.fav-main { background: #ffffff; border-radius: 12px; padding: 24px; }
.fav-title { font-size: clamp(32px, 6vw, 72px); color: #6b4f2a; font-weight: 800; letter-spacing: 4px; margin: 6px 0 24px; border-bottom: 4px solid #6b4f2a; padding-bottom: 6px; }

/* è¡¨æ ¼æ¨£å¼ */
.fav-card { background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding: 0; overflow:hidden; }
.fav-table { width:100%; border-collapse: collapse; }
.fav-table th, .fav-table td { padding: 12px 16px; border-bottom: 1px solid #eee; vertical-align: middle; }
.fav-table th { background:#faf7f2; color:#6b4f2a; font-weight:700; }
.fav-table tr:last-child td { border-bottom:none; }

/* åˆªé™¤/ç§»é™¤æŒ‰éˆ• */
.btn-outline-danger { border:1px solid #e3b1b1; color:#a45050; background:#fff; padding:6px 10px; border-radius:8px; }
.btn-outline-danger:hover { background:#fde9e9; }

/* å³ä¸‹è§’ç¸½è¨ˆ */
.fav-total { text-align: right; margin-top: 10px; color:#6b4f2a; font-weight:700; }

/* ç©ºæ¸…å–®æç¤º */
.fav-empty { margin-top: 12px; }
</style>

<div class="fav-shell">
  <!-- å´é‚Šæ¬„ -->
  <aside class="fav-side">
    <div class="fav-user">{{ current_user.name if current_user is defined and current_user else 'è¨ªå®¢ / æœƒå“¡' }}</div>
    <ul class="fav-menu">
      <li class="{{ 'is-active' if request.path.startswith('/home') else '' }}">
        <a href="/home">FoodMap</a>
      </li>
      <li class="{{ 'is-active' if request.path.startswith('/home') else '' }}">
        <a href="/home">å³é£Ÿå“åœ°åœ–</a>
      </li>
      <li class="{{ 'is-active' if request.path.startswith('/recommend') else '' }}">
        <a href="/recommend">æ¨è–¦å•†å“</a>
      </li>
      <li class="{{ 'is-active' if request.path.startswith('/cart') else '' }}">
        <a href="/cart">å–œå¥½é …ç›®</a>
      </li>
      <li class="{{ 'is-active' if request.path.startswith('/notifications') else '' }}">
        <a href="/notifications">é€šçŸ¥</a>
      </li>
    </ul>
  </aside>


  <!-- å³å´å…§å®¹ -->
  <main class="fav-main">
    <h1 class="fav-title">FoodMap</h1>

    {% if items and items|length > 0 %}
      {% set totals = namespace(value=0) %}
      <div class="fav-card">
        <table class="fav-table" id="fav-table">
          <thead>
            <tr>
              <th style="width:28%;">åº—å®¶</th>
              <th>å“å</th>
              <th style="width:12%;">å–®åƒ¹</th>
              <th style="width:12%;">æ•¸é‡</th>
              <th style="width:12%;">å°è¨ˆ</th>
              <th style="width:10%;"></th>
            </tr>
          </thead>
          <tbody>
            {% for it in items %}
              {% set unit = (it.final_price if it.final_price is not none else it.price) | float %}
              {% set qty  = (it.qty if it.qty is not none else 1) | int %}
              {% set totals.value = totals.value + (unit * qty) %}

              <tr>
                <td>{{ it.store_name }}</td>
                <td>
                  {{ it.name }}
                  <span class="text-warning">
                    {% for i in range((it.avg_rating or 0)|int) %}â˜…{% endfor %}
                    {% for i in range(5-((it.avg_rating or 0)|int)) %}â˜†{% endfor %}
                  </span>
                  {% if it.discount_rate and it.discount_rate < 1 %}
                    <span class="badge bg-danger ms-1">{{ (it.discount_rate*10)|round(1) }} æŠ˜</span>
                  {% endif %}
                </td>
                <td>${{ unit }}</td>
                <td>{{ it.qty if it.qty is not none else 1 }}</td>
                <td>${{ (unit * (it.qty if it.qty is not none else 1))|round(2) }}</td>
                <td><button class="btn btn-sm btn-outline-danger" onclick="removeItem({{ it.cart_item_id }})">åˆªé™¤</button></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="fav-total" id="fav-total">ç¸½è¨ˆï¼š${{ totals.value|round(2) }}</div>

      {% if any_discount %}
      <div class="alert alert-success mt-3">ğŸ‰ ä½ çš„å–œå¥½é …ç›®å…§æœ‰æŠ˜æ‰£å•†å“ï¼</div>
      {% endif %}

    {% else %}
      <div class="alert alert-info fav-empty">å–œå¥½é …ç›®æ˜¯ç©ºçš„ã€‚</div>
    {% endif %}
  </main>
</div>

<script>
  // å¾åŸ cart.html æ¬å›ä¾†ï¼šåˆªé™¤æ”¶è—/é …ç›®å¾Œç«¯ API
  async function removeItem(id){
    const form = new FormData();
    form.append("cart_item_id", id);
    try{
      const r = await fetch("{{ url_for('api_remove_item') }}", { method:"POST", body: form });
      const j = await r.json();
      if(j.ok){ location.reload(); }
      else { alert("åˆªé™¤å¤±æ•—"); }
    }catch(e){
      alert("åˆªé™¤å¤±æ•—");
      console.error(e);
    }
  }
</script>

{% endblock %}

