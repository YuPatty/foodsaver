<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}FoodMap{% endblock %}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/flash.css') }}">

</head>

<body class="bg-light">

<div class="container-fluid">
  <div class="row g-0">
    <!-- å·¦å´å´æ¬„ -->
    <aside class="col-12 col-md-3 col-lg-2 p-3 sidebar">
            <!-- å´æ¬„ä¸Šæ–¹ä½¿ç”¨è€…å€ -->
      <div class="d-flex align-items-center gap-2 mb-3">
        {% if not session.get('user_id') %}
          <a href="{{ url_for('login') }}" class="d-flex align-items-center gap-2 text-decoration-none" style="cursor:pointer">
            <div class="avatar rounded-circle bg-secondary-subtle d-flex justify-content-center align-items-center">ğŸ‘¤</div>
            <div class="small">
              <div class="text-muted">è¨ªå®¢ / æœƒå“¡ï¼ˆé»æ­¤ç™»å…¥ï¼‰</div>
            </div>
          </a>
        {% else %}
          <a href="{{ url_for('profile') }}" class="text-decoration-none text-body">
            <div class="d-flex align-items-center gap-2">
              <div class="avatar rounded-circle bg-secondary-subtle d-flex justify-content-center align-items-center">ğŸ‘¤</div>
              <div class="small">
                <div><strong>{{ session.get('username') }}</strong></div>
                <div class="text-muted">æœƒå“¡</div>
              </div>
            </div>
          </a>
        {% endif %}
      </div>


      <nav class="nav flex-column gap-2">
        <a class="nav-link {% if request.endpoint=='home' or request.endpoint=='index' %}active{% endif %}"
          href="{{ url_for('index') }}">å³é£Ÿå“åœ°åœ–</a>

        <a class="nav-link {% if request.endpoint=='recommend_page' %}active{% endif %}"
          href="{{ url_for('recommend_page') }}">ğŸ” å•†å“</a>

        {% if session.get('user_id') %}
          <a class="nav-link {% if request.endpoint=='favorites_page' %}active{% endif %}"
            href="{{ url_for('favorites_page') }}">å–œå¥½æ¸…å–®</a>
          <a class="nav-link {% if request.endpoint=='notifications_page' %}active{% endif %}"
            href="{{ url_for('notifications_page') }}">é€šçŸ¥</a>
        {% else %}
          <!-- æœªç™»å…¥ï¼šé»äº†å°±å»ç™»å…¥ -->

          <a class="nav-link" href="{{ url_for('login') }}">å–œå¥½æ¸…å–®</a>
          <a class="nav-link" href="{{ url_for('login') }}">é€šçŸ¥</a>
        {% endif %}
        
        {% if current_user %}
          <a class="nav-link" href="{{ url_for('logout') }}">ç™»å‡º</a>
        {% else %}
          <a class="nav-link" href="{{ url_for('login') }}">ç™»å…¥</a>
        {% endif %}
      </nav>

    </aside>

    <!-- å³å´ä¸»å…§å®¹ -->
    <main class="col-12 col-md-9 col-lg-10 p-3">
      <div class="page-title text-center mb-3">é£Ÿåˆ†å¥½æ‰¾</div>
      {% with msgs = get_flashed_messages(with_categories=True) %}
        {% if msgs %}
          {% for cat, m in msgs %}
            <div class="alert alert-{{ 'danger' if cat=='err' else 'success' }} py-2">{{ m }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>
  </div>
</div>
<style>
  .toast-stack {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1080; /* é«˜æ–¼ navbar/offcanvas */
  }
  .toast .toast-body { font-size: .95rem; }
  .toast .bi { margin-right:.4rem; }
</style>

<div class="toast-stack" id="toastStack" aria-live="polite" aria-atomic="true"></div>

<!-- ç¢ºèªå°è©±æ¡†ï¼ˆé€šç”¨ï¼‰ -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h6 class="modal-title" id="confirmTitle">è«‹ç¢ºèª</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
      </div>
      <div class="modal-body" id="confirmMessage">ç¢ºå®šè¦åŸ·è¡Œé€™å€‹å‹•ä½œå—ï¼Ÿ</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="confirmCancel">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="confirmOk">ç¢ºå®š</button>
      </div>
    </div>
  </div>
</div>

<!-- å³ä¸‹è§’å›ºå®šçš„ AI è©¢å•æŒ‰éˆ• -->
<button id="aiQueryButton" 
        class="btn btn-warning position-fixed" 
        style="right:20px; bottom:20px; z-index:1045;" 
        data-bs-toggle="offcanvas" 
        data-bs-target="#aiOffcanvas">
  AI è©¢å•
</button>

<!-- Offcanvas å´é‚Šè¦–çª— -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="aiOffcanvas" aria-labelledby="aiOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 id="aiOffcanvasLabel">AI è©¢å•</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column" style="gap:10px;">
    <div class="mb-2 small text-muted">è©¢å•åƒæ˜¯ã€Œä»Šå¤©åƒä»€éº¼ï¼Ÿã€æœƒå„ªå…ˆå¾è³‡æ–™åº«çš„ã€Œç‰¹åƒ¹å•†å“ã€æ¨è–¦ã€‚</div>
    <div class="flex-grow-1 border rounded p-2" id="aiChatArea" style="overflow:auto; background:#fff;"></div>
    <div class="input-group">
      <input id="aiInput" type="text" class="form-control" placeholder="è¼¸å…¥å•é¡Œ..." />
      <button id="aiSend" class="btn btn-primary">é€å‡º</button>
    </div>
  </div>
</div>

<!-- JS é‚è¼¯ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const aiQueryButton = document.getElementById('aiQueryButton'); 
    const aiOffcanvasElement = document.getElementById('aiOffcanvas');

    if (aiQueryButton && aiOffcanvasElement) {
        // 1. æŒ‰ä¸‹æŒ‰éˆ• â†’ ç«‹åˆ»éš±è—
        aiQueryButton.addEventListener('click', function () {
            aiQueryButton.style.display = 'none';
        });

        // 2. Offcanvas é—œé–‰å¾Œ â†’ æŒ‰éˆ•å†å‡ºç¾
        aiOffcanvasElement.addEventListener('hidden.bs.offcanvas', function () {
            aiQueryButton.style.display = '';
        });
    } else {
        console.warn("æ‰¾ä¸åˆ° aiQueryButton æˆ– aiOffcanvasï¼Œè«‹æª¢æŸ¥ ID æ˜¯å¦æ­£ç¢ºã€‚");
    }
});
</script>

{% block scripts %}

    {# front_remaining_final integration START #}
    {% include "components/sale-popup.html" %}
    <script src="{{ url_for('static', filename='js/sale-popup.js') }}"></script>
    <script src="{{ url_for('static', filename='js/favorites-hook.js') }}"></script>
    <script src="{{ url_for('static', filename='js/daily-sale-reminder.js') }}"></script>
    {# front_remaining_final integration END #}


<script>
(async function(){
  const chat = document.getElementById('aiChatArea');
  const input = document.getElementById('aiInput');
  const sendBtn = document.getElementById('aiSend');

  function append(role, text){
    const div = document.createElement('div');
    div.className = role === 'user' ? 'text-end' : 'text-start';
    const bubble = document.createElement('div');
    bubble.className = 'd-inline-block px-3 py-2 rounded-3 ' + (role==='user' ? 'bg-primary text-white' : 'bg-light border');
    bubble.textContent = text;
    div.appendChild(bubble);
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  async function ask(){
    const q = (input.value || '').trim();
    if (!q) return;
    append('user', q);
    input.value = '';
    try{
      const r = await fetch('/api/ai_ask', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({question: q})
      });
      const j = await r.json();
      append('bot', j.ok ? j.answer : ('éŒ¯èª¤ï¼š' + j.error));
    }catch(err){
      append('bot', 'éŒ¯èª¤ï¼š' + err);
    }
  }
  if (sendBtn) sendBtn.onclick = ask;
  if (input) input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') ask(); });
})();
</script>
<script>
/** Toastï¼šæ¼‚äº®çš„å°é»‘æ¡†é€šçŸ¥
 *  toast('å·²åŠ å…¥å–œæ„›') / toast('ç™¼ç”ŸéŒ¯èª¤','danger')
 *  typeï¼šprimary|success|warning|danger|info|secondary|dark|light
 */
function toast(message, type='success', title='') {
  const stack = document.getElementById('toastStack');
  const id = 't' + Date.now();

  const iconMap = {
    success: 'check-circle-fill', danger:'x-circle-fill',
    warning:'exclamation-triangle-fill', info:'info-circle-fill',
    primary:'info-circle-fill', secondary:'dot', dark:'dot', light:'dot'
  };
  const icon = iconMap[type] || 'info-circle-fill';

  const el = document.createElement('div');
  el.className = `toast align-items-center text-bg-${type} border-0`;
  el.id = id;
  el.role = 'status'; el.ariaLive = 'assertive'; el.ariaAtomic = 'true';
  el.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        ${title ? `<strong class="me-2">${title}</strong>` : ''}
        <i class="bi bi-${icon}"></i>${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  `;
  stack.appendChild(el);

  const t = new bootstrap.Toast(el, { delay: 2200, autohide: true });
  t.show();
  el.addEventListener('hidden.bs.toast', () => el.remove());
}

/** Confirmï¼šæ¼‚äº®çš„ç¢ºèªæ¡†ï¼Œå›å‚³ Promise<boolean>
 *  if (await confirmBox('åŠ å…¥å–œæ„›','ç¢ºå®šåŠ å…¥å—ï¼Ÿ')) {...}
 */
function confirmBox(title='è«‹ç¢ºèª', message='è¦ç¹¼çºŒå—ï¼Ÿ', okText='ç¢ºå®š', cancelText='å–æ¶ˆ') {
  return new Promise((resolve) => {
    const m = document.getElementById('confirmModal');
    m.querySelector('#confirmTitle').textContent = title;
    m.querySelector('#confirmMessage').textContent = message;
    m.querySelector('#confirmOk').textContent = okText;
    m.querySelector('#confirmCancel').textContent = cancelText;

    const modal = new bootstrap.Modal(m);
    const okBtn = m.querySelector('#confirmOk');
    const cancelBtn = m.querySelector('#confirmCancel');

    const clean = () => {
      okBtn.removeEventListener('click', onOk);
      m.removeEventListener('hidden.bs.modal', onHide);
    };
    const onOk = () => { clean(); modal.hide(); resolve(true); };
    const onHide = (e) => { clean(); resolve(false); };

    okBtn.addEventListener('click', onOk, { once:true });
    m.addEventListener('hidden.bs.modal', onHide, { once:true });
    modal.show();
  });
}
</script>
{% endblock %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
